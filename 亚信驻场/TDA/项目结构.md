# NGTDA-Main 项目结构分析

这是 NGTDA（Threat Discovery Appliance，威胁发现设备） 的整机工程，面向 Kylin（麒麟） 和 Debian 11 (bullseye) 构建，用于编译、打包并生成安装包/ISO。

---

## 根目录关键文件

|文件|作用|
|---|---|
|README.md|编译说明：环境要求、require.sh、make update、make、make iso、make ptn_update、make make_hotfix 等|
|require.sh|构建环境准备：按 Kylin / Debian 安装依赖（gcc、MongoDB C 驱动、hiredis、zeromq、PF_RING、Python3 等）|
|Makefile|顶层构建：先 component_scan（dpid）、feedback，再 ui / orca / venv / backend / eng_ptn / ept / upgrade / audit|
|top.mk|通用构建变量与宏：staging_dir、安装路径 /usr/vtm、OS 类型、架构等|
|tda_package_build.sh|将编译产物打成 Kylin 安装包（tar.gz），内含 RPM 与 ISO 相关文件|
|update_manual.py|与 make ptn_update 配合，用于更新各引擎的 pattern 等|

---

## 主要目录说明

### 1. backend/ — 本地 Web 后端

- 作用：NGTDA 本地管理界面对应的 Flask 后端（API、数据库、系统管理）。

- 结构要点：

- src/：app.py（Flask 入口）、api/、route.py、db/、decorator.py、sysmg/、utils/

- init/：ClickHouse、Mongo 等初始化脚本/配置

- etc/：babel 国际化、SNMP 等配置

- DEBIAN/、SPECS/：Debian/RPM 打包

- 依赖：Python 3.8.12，见 README。

---

### 2. ui/ — 前端与本地服务

- 作用：管理界面前端（React/Vue 等）及对外提供静态资源的本地服务。

- 结构要点：

- src/、src_max/：前端源码（JSX、Vue、Less 等）

- build/、build_max/：构建产物与可视化/大屏资源（vis、静态资源）

- koaServer/：Koa 静态资源/语言包服务

- public/：index.html、静态资源、worker 等

- DEBIAN/、SPECS/：打包配置

---

### 3. orca/ — 威胁分析引擎（ORCA）

- 全称：Orchestrated RootCause Analyzer（编排式根因分析）。

- 作用：威胁/告警分析流水线：数据接入、预处理、规则/ML 分析、资产评级、报表等。

- 结构要点：

- main.py：入口，加载 orca_conf.yaml，初始化框架与日志。

- base/：框架、分析引擎、配置、数据库、插件接口、报表、服务管理等基础能力。

- conf/：各业务配置（asset_rating、audit、dns_ml、web_attack_ml、pwd_broker 等）。

- plugin/：具体分析/数据源/输出插件。

- pattern/：规则与映射（bulk、ext、mapping、self_defined 等）。

- install/：systemd 服务定义（orca、asset_rating、merge_alert、dns_ml、webshell_ml 等）。

- unit_test/、sub_module/：单测与子模块。

---

### 4. component_scan/ — 流量/组件扫描（dpid）

- 作用：C/C++ 实现的 dpid 及相关组件，做流量采集、日志、监控等。

- 结构要点：

- dpid/：dpid 主程序与协议解析。

- libcommon/、logmod/：公共库与日志模块。

- conf/：systemd（dpid.service、log_transfer）、cron、vtm 配置（anti_malware、dpid 等）。

- scripts/：如 log_transfer.py、purge_mongodb_data.py、tda_monitor.py。

- 产出：RPM/DEB（Kylin 下先打 RPM，Debian 下打 DEB）。

---

### 5. TMCore-Build/ — 核心引擎库（预编译/封装）

- 作用：封装各安全引擎的 预编译库和头文件，供 component_scan 等模块链接。

- 子目录：

- Ids_Engine (ns_engine)：网络栈/IDS 相关（libnsengine.so）。

- Maldium：恶意代码相关（libmmeng.so）。

- MDEng：恶意检测引擎（libmdeng.so 等），带 Python 工具。

- SFBeng：另一类引擎（libsfbe.so）。

- Flow_Print/、Cloudpi-SDK/：流量/采集相关 SDK 或工具。

---

### 6. OpenSource/ — 第三方开源依赖

- 作用：在 Kylin 上从源码构建并安装的第三方库（Debian 上部分用系统包）。

- 包含：arrow、clickhouse、libbpf/ebpf、hiredis、jemalloc、liburcu、PF_RING、lexertl 等。

- 构建出的头文件/库会通过 staging_dir 提供给 component_scan 等模块。

---

### 7. eng_ptn/ — 引擎 Pattern 包

- 作用：把各引擎的 规则/特征库（pattern） 打成 RPM/DEB，安装到 /usr/vtm/pattern 等。

- 子目录：

- asset_ptn/：DPI 资产映射等。

- mald_ptn/：Maldium 规则（mmc/mmcd）。

- md_ptn/、md_ptn_poc/：MD 引擎规则（mdb、mdm、mdg 等）。

- ns_ptn/、ns_ptn_poc/：NS/IDS 引擎规则（nsd、nsc 等）。

---

### 8. audit/ — 审计引擎

- 作用：安全审计相关二进制与库（登录审计、规则引擎、AI 检测等）。

- 内容：多架构（x86_64/aarch64）的 audit_eng、配置（audit_eng.conf、login.json、mininseng.yaml）及 lib（libaudit_.so、libmininseng 等），打包为 RPM/DEB。

---

### 9. feedback/ — 产品反馈服务

- 作用：采集并上报产品反馈的 xfbd 服务（C++ 实现 + Python 脚本）。

- 内容：xfbd 源码、SfbSdk、ini 配置、systemd 服务、cron（如 ProductFB），打包为 RPM/DEB。

---

### 10. iso/ — ISO 构建

- 作用：生成安装 ISO（make iso 会进入此目录）。

- 实际 ISO 内容和脚本多在构建时生成，仓库里多为占位或子模块（如含 .git）。

---

### 11. make_hotfix/ — 热修复包制作

- 作用：将已编译好的 RPM/DEB 打成热修复包（用于小版本升级、安全补丁等）。

- 内容：make_hotfix.py、config_*.yaml、all_deb/、all_rpm/、upgrade_deb/、upgrade_rpm/ 等，以及签名相关（如 sign.key）。

---

### 12. upgrade/ — 系统升级逻辑

- 作用：设备系统/软件升级脚本与服务。

- 内容：upgrade.py、upgrade.service、DEBIAN/SPECS 打包，供安装或热修复流程调用。

---

### 13. venv/ — Python 虚拟环境

- 作用：为 backend、orca 等提供统一的 Python 运行环境（依赖与版本隔离），在 make 时会被构建/安装。

---

### 14. ept/（在 Makefile 中）

- Makefile 里 sub_targets 包含 ept，并有 clean/distclean 目标，但当前仓库中未看到 ept 目录，可能是未拉取的子模块或历史目标，实际构建时若缺少会报错。

---

## 构建流程概览

1. 环境：在 Kylin 或 Debian 11 上执行 require.sh 安装依赖。

2. 依赖：

- Kylin：make 会编 OpenSource 和 TMCore-Build（本仓库中 TMCore-Build 多为已编译产物）。

- 然后编 component_scan（dpid）和 feedback。

1. 应用与包：再编 ui、orca、venv、backend、eng_ptn、upgrade、audit（若有 ept 则也会编）。

2. 产出：

- staging_dir/rpms（或 deb）下为各组件 RPM/DEB。

- make iso → 在 staging_dir 生成 ISO。

- tda_package_build.sh → 打成 Kylin 安装 tar.gz。

- make make_hotfix → 打热修复包。